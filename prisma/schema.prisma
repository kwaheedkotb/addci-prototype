generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Application {
  id               String        @id @default(cuid())
  applicantName    String
  organizationName String
  email            String
  sector           String
  description      String
  status           String        @default("SUBMITTED") // SUBMITTED, UNDER_REVIEW, CORRECTIONS_REQUESTED, APPROVED, REJECTED
  aiPrecheckResult String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  reviewNotes      ReviewNote[]
  certificate      Certificate?
  documents        ApplicationDocument[]

  // Extended ESG fields
  phoneNumber         String?
  tradeLicenseNumber  String?
  subSector           String?
  country             String?

  // ESG Profile JSON fields (stored as JSON strings)
  environmentalProfile String?  // JSON: { description, carbonEmissions, energyReduction, ... }
  socialProfile        String?  // JSON: { description, workforceDiversity, communityPrograms, ... }
  governanceProfile    String?  // JSON: { description, boardStructure, complianceFrameworks, ... }
}

model ReviewNote {
  id            String      @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  authorType    String      // SYSTEM, STAFF
  note          String
  createdAt     DateTime    @default(now())
}

model Certificate {
  id                  String      @id @default(cuid())
  applicationId       String      @unique
  application         Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  certificateNumber   String      @unique
  issuedAt            DateTime    @default(now())
  validUntil          DateTime?   // Certificate expiry date
  renewalSuggestedAt  DateTime?   // Date to remind for renewal
}

model Service {
  id          Int      @id @default(autoincrement())
  dept        String
  platform    String   // "ADC Platform", "TAMM", "Affiliates Platform"
  name        String
  nameAr      String   // Arabic name
  description String
  descriptionAr String // Arabic description
  channelType String   // "INTERNAL" or "EXTERNAL"
  externalUrl String?
  tags        String?  // Store JSON string of keywords (EN)
  tagsAr      String?  // Store JSON string of keywords (AR)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ApplicationDocument {
  id            Int      @id @default(autoincrement())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  type          String   // "ESG_POLICY", "REPORT", "CERTIFICATION", etc.
  detectedType  String?  // AI-detected document type
  confidence    Float?   // AI confidence score for detected type
  fileName      String
  filePath      String   // path to stored file
  ocrText       String?  // text extracted via OCR/ICR
  aiReview      String?  // AI validation / comments on the document
  createdAt     DateTime @default(now())
}

// ─────────────────────────────────────────────────────────────────────────────
// STAFF PORTAL — Enums
// ─────────────────────────────────────────────────────────────────────────────

enum StaffApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PENDING_INFO
  CLOSED
}

enum ServiceType {
  KNOWLEDGE_SHARING
  CHAMBER_BOOST
  BUSINESS_MATCHMAKING
  ESG_LABEL
  BUSINESS_DEVELOPMENT
  BUSINESS_ENABLEMENT
  POLICY_ADVOCACY
  LOYALTY_PLUS
  AD_CONNECT_CONCIERGE
}

enum StaffRole {
  ADMIN
  REVIEWER
  VIEWER
}

// ─────────────────────────────────────────────────────────────────────────────
// STAFF PORTAL — Models
// ─────────────────────────────────────────────────────────────────────────────

model StaffUser {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  nameAr      String
  role        StaffRole @default(REVIEWER)
  department  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  assignedApplications BaseApplication[] @relation("AssignedStaff")
}

model BaseApplication {
  id                  String                  @id @default(cuid())
  serviceType         ServiceType
  status              StaffApplicationStatus  @default(SUBMITTED)
  submittedBy         String
  submittedByEmail    String
  memberTier          String
  assignedToId        String?
  assignedTo          StaffUser?              @relation("AssignedStaff", fields: [assignedToId], references: [id])
  submittedAt         DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  reviewedAt          DateTime?
  reviewedBy          String?
  internalNotes       String?
  rejectionReason     String?
  satisfactionScore   Int?
  satisfactionComment String?

  activityLogs        ActivityLog[]
  esgApplication      EsgApplication?
  knowledgeSharingApplication KnowledgeSharingApplication?
  chamberBoostApplication     ChamberBoostApplication?
}

model EsgApplication {
  id                   String          @id @default(cuid())
  baseApplication      BaseApplication @relation(fields: [baseApplicationId], references: [id], onDelete: Cascade)
  baseApplicationId    String          @unique

  // ESG-specific fields
  phoneNumber          String?
  tradeLicenseNumber   String?
  subSector            String?
  country              String?
  environmentalProfile String?
  socialProfile        String?
  governanceProfile    String?

  // Multi-phase ESG workflow
  eoiSubmittedAt       DateTime?
  eoiApprovedAt        DateTime?
  fullAppSubmittedAt   DateTime?
  fullAppReviewedAt    DateTime?
  endorsedAt           DateTime?

  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
}

model KnowledgeSharingApplication {
  id                     String          @id @default(cuid())
  baseApplication        BaseApplication @relation(fields: [baseApplicationId], references: [id], onDelete: Cascade)
  baseApplicationId      String          @unique

  requestType            String          // 'CALENDAR_BOOKING' | 'TRAINING_QUERY'
  programType            String?         // 'Knowledge Series' | 'Upskilling Program'
  programTypeAr          String?
  programName            String?
  programNameAr          String?
  sessionDate            DateTime?
  sessionDates           String?         // JSON array for multiple dates
  numberOfAttendees      Int?
  attendeeDetails        String?         // JSON array { name, email, phone }
  queryText              String?
  attachmentUrl          String?
  attachmentName         String?

  // Staff response fields
  responseText           String?
  responseAttachmentUrl  String?
  responseAttachmentName String?
  respondedAt            DateTime?
  respondedBy            String?

  // Post-completion
  surveySentAt           DateTime?
  completedAt            DateTime?

  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
}

model ChamberBoostApplication {
  id                  String          @id @default(cuid())
  baseApplication     BaseApplication @relation(fields: [baseApplicationId], references: [id], onDelete: Cascade)
  baseApplicationId   String          @unique

  // Deal details
  dealId              String
  dealTitle           String
  dealTitleAr         String?
  dealType            String          // 'UNLIMITED' | 'LIMITED'
  vendorName          String
  vendorNameAr        String?
  category            String
  categoryAr          String?

  // Member request details
  companySize         String?
  intendedUse         String?
  additionalNotes     String?

  // Fulfillment fields
  voucherCode         String?
  vendorRedirectUrl   String?
  fulfilledAt         DateTime?
  fulfilledBy         String?
  rejectionReason     String?
  expiryDate          DateTime?

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
}

model ActivityLog {
  id            String      @id @default(cuid())
  applicationId String
  application   BaseApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  serviceType   ServiceType
  action        String
  performedBy   String
  performedAt   DateTime    @default(now())
  notes         String?
}
